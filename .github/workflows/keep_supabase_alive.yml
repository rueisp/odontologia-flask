# .github/workflows/keep_supabase_alive.yml

name: Keep Supabase Project Alive

on:
  schedule:
    - cron: '0 0 * * 1,3,5' 
  workflow_dispatch: # <--- Asegúrate de que esto esté aquí para ejecución manual

jobs:
  ping:
    runs-on: ubuntu-latest
    # Define variables de entorno para este job.
    # Aquí inyectamos el SECRET que crearemos en GitHub.
    env: # <--- 'env' debe estar indentado 4 espacios desde 'jobs'
      DATABASE_URL_SUPABASE: ${{ secrets.SUPABASE_DATABASE_URL }} # <--- Esta línea debe estar indentada 2 espacios desde 'env'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3 

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: Install dependencies
        run: pip install psycopg2-binary

      - name: Ping Supabase Database
        run: |
          python -c "import psycopg2, os, datetime, sys; db_url = os.environ.get('DATABASE_URL_SUPABASE');
           if not db_url: print(f'[{datetime.datetime.now()}] ERROR: DATABASE_URL_SUPABASE no está configurada.', 
           file=sys.stderr); sys.exit(1); try: conn = psycopg2.connect(db_url); 
           cur = conn.cursor(); cur.execute('SELECT 1'); cur.close(); conn.close(); print(f'[{datetime.datetime.now()}] 
           INFO: Ping exitoso a Supabase.'); except Exception as e: print(f'[{datetime.datetime.now()}] 
           ERROR: Falló el ping a Supabase: {e}', file=sys.stderr); sys.exit(1);"