<!-- Archivo: clinica/templates/_accordion_registro_paciente.html -->
{% from '_componentes_paciente.html' import render_campo, render_campo_textarea %}

{# ¬°IMPORTANTE! Hemos ELIMINADO EL DIV.ACCORDION EXTERIOR.
   Ahora, cada 'accordion-item card-custom mb-3' act√∫a como una tarjeta individual.
   El 'data-bs-parent' en los botones debe apuntar al ID del primer item para mantener el comportamiento de acorde√≥n. #}

    <!-- =========== SECCI√ìN 0: DATOS PERSONALES (PRIMER ITEM) =========== -->
    {# Cada accordion-item ahora incluye 'card-custom mb-3' para darle la apariencia de tarjeta individual #}
    <div class="accordion-item card-custom mb-3" id="accordionRegistroPaciente"> {# CAMBIO: El ID del grupo se mueve aqu√≠. #}
        <h2 class="accordion-header" id="headingDatosPersonales">
            {# Este bot√≥n est√° expandido por defecto (sin 'collapsed') y con 'aria-expanded="true"' #}
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDatosPersonales" aria-expanded="true" aria-controls="collapseDatosPersonales">
                <i data-lucide="user-circle" class="accordion-icon"></i>
                <strong>Datos Personales</strong>
            </button>
        </h2>
        {# Este contenido est√° visible por defecto (con 'show') #}
        <div id="collapseDatosPersonales" class="accordion-collapse show" aria-labelledby="headingDatosPersonales" data-bs-parent="#accordionRegistroPaciente">
            <div class="accordion-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="nombres" class="form-label">Nombres <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nombres" name="nombres" value="{{ paciente.nombres or '' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="apellidos" class="form-label">Apellidos <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="apellidos" name="apellidos" value="{{ paciente.apellidos or '' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="tipo_documento" class="form-label">Tipo de Documento <span class="text-danger">*</span></label>
                        <select class="form-select" id="tipo_documento" name="tipo_documento" required>
                            <option value="">Seleccione</option>
                            <option value="CC" {% if paciente and paciente.tipo_documento == 'CC' %}selected{% endif %}>C√©dula de Ciudadan√≠a</option>
                            <option value="TI" {% if paciente and paciente.tipo_documento == 'TI' %}selected{% endif %}>Tarjeta de Identidad</option>
                            <option value="RC" {% if paciente and paciente.tipo_documento == 'RC' %}selected{% endif %}>Registro Civil</option>
                            <option value="CE" {% if paciente and paciente.tipo_documento == 'CE' %}selected{% endif %}>C√©dula de Extranjer√≠a</option>
                            <option value="PA" {% if paciente and paciente.tipo_documento == 'PA' %}selected{% endif %}>Pasaporte</option>
                            <option value="PPT" {% if paciente and paciente.tipo_documento == 'PPT' %}selected{% endif %}>Permiso de Protecci√≥n</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="documento" class="form-label">Documento <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="documento" name="documento" value="{{ paciente.documento or '' }}" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento" value="{{ paciente.fecha_nacimiento or '' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="edad" class="form-label">Edad <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="edad" name="edad" value="{{ paciente.edad or '' }}" required readonly>
                    </div>
                    <div class="col-md-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ paciente.email or '' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="telefono" class="form-label">Tel√©fono <span class="text-danger">*</span></label>
                        <input type="text" pattern="\d{7,15}" title="Solo n√∫meros, entre 7 y 15 d√≠gitos" class="form-control" id="telefono" name="telefono" value="{{ paciente.telefono or '' }}" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="genero" class="form-label">G√©nero</label>
                        <select class="form-select" id="genero" name="genero">
                            <option value="" {% if paciente and paciente.genero == '' %}selected{% endif %}>Seleccione</option>
                            <option value="Masculino" {% if paciente and paciente.genero == 'Masculino' %}selected{% endif %}>Masculino</option>
                            <option value="Femenino" {% if paciente and paciente.genero == 'Femenino' %}selected{% endif %}>Femenino</option>
                            <option value="Otro" {% if paciente and paciente.genero == 'Otro' %}selected{% endif %}>Otro</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="estado_civil" class="form-label">Estado Civil</label>
                        <select class="form-select" id="estado_civil" name="estado_civil">
                             <option value="" {% if paciente and paciente.estado_civil == '' %}selected{% endif %}>Seleccione</option>
                             <option value="Soltero/a" {% if paciente and paciente.estado_civil == 'Soltero/a' %}selected{% endif %}>Soltero/a</option>
                             <option value="Casado/a" {% if paciente and paciente.estado_civil == 'Casado/a' %}selected{% endif %}>Casado/a</option>
                             <option value="Uni√≥n Libre" {% if paciente and paciente.estado_civil == 'Uni√≥n Libre' %}selected{% endif %}>Uni√≥n Libre</option>
                             <option value="Separado/a" {% if paciente and paciente.estado_civil == 'Separado/a' %}selected{% endif %}>Separado/a</option>
                             <option value="Viudo/a" {% if paciente and paciente.estado_civil == 'Viudo/a' %}selected{% endif %}>Viudo/a</option>
                        </select>
                    </div>
                                    {# --- CAMPO PARA IMAGEN DE PERFIL (ESTILO CONSULTORIO.ME) --- #}
                    <div class="col-md-6 text-center"> {# Centramos el contenido de la columna #}
                        <label class="form-label d-block mb-2">Imagen de Perfil</label>
                        <div class="avatar-upload-container mx-auto"> {# A√±adido mx-auto para centrar #}
                            <img id="profile-picture-preview" 
                                 src="{{ paciente.imagen_perfil_url or url_for('static', filename='img/placeholder_avatar.png') }}" 
                                 alt="Avatar" 
                                 class="rounded-circle border" 
                                 style="width: 100px; height: 100px; object-fit: cover;">
                            
                            <input type="file" 
                                   id="imagen_perfil_input" 
                                   name="imagen_perfil" 
                                   accept="image/*" 
                                   class="d-none"> {# Oculta el input de archivo por defecto #}
                            
                            <div class="avatar-actions">
                                <button type="button" class="btn btn-sm btn-light rounded-circle p-1 camera-btn" title="Tomar foto">
                                    <i data-lucide="camera" style="width: 18px; height: 18px;"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-light rounded-circle p-1 upload-btn" title="Subir imagen">
                                    <i data-lucide="upload" style="width: 18px; height: 18px;"></i>
                                </button>
                            </div>
                        </div>
                        {% if paciente and paciente.imagen_perfil_url %}
                            <div class="form-check mt-3"> {# Margen superior para separarlo del avatar #}
                                <input class="form-check-input mx-auto" type="checkbox" name="eliminar_imagen_perfil" id="eliminar_imagen_perfil">
                                <label class="form-check-label" for="eliminar_imagen_perfil">
                                    Eliminar imagen actual
                                </label>
                            </div>
                        {% endif %}
                    </div>
                    {# --- FIN CAMPO PARA IMAGEN DE PERFIL --- #}
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="patientIdHiddenInput" value="{{ paciente.id or '' }}">
    <!-- =========== FIN SECCI√ìN 0: DATOS PERSONALES =========== -->

    <!-- =========== SECCI√ìN 1: DIRECCI√ìN Y ASEGURADORA =========== -->
<div class="accordion-item card-custom mb-3">
    <h2 class="accordion-header" id="headingDireccionAseguradora">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDireccionAseguradora" aria-expanded="false" aria-controls="collapseDireccionAseguradora">
            <i data-lucide="map-pin" class="accordion-icon"></i>
            <strong>Direcci√≥n y Aseguradora</strong>
        </button>
    </h2>
    <div id="collapseDireccionAseguradora" class="accordion-collapse collapse" aria-labelledby="headingDireccionAseguradora" data-bs-parent="#accordionRegistroPaciente">
        <div class="accordion-body">
            <div class="row mb-3">
                {{ render_campo('Direcci√≥n', 'direccion', paciente) }}
                {{ render_campo('Barrio', 'barrio', paciente) }}
                {{ render_campo('Municipio', 'municipio', paciente) }}
                {{ render_campo('Departamento', 'departamento', paciente) }}
            </div>
            <div class="row mb-3">
                {{ render_campo('Nombre de Aseguradora', 'aseguradora', paciente) }}
                <div class="col-md-3">
                    <label for="tipo_vinculacion" class="form-label">Tipo de Vinculaci√≥n</label>
                    <select class="form-select" id="tipo_vinculacion" name="tipo_vinculacion">
                        <option value="" {% if paciente and paciente.tipo_vinculacion == '' %}selected{% endif %}>Seleccione</option>
                        <option value="Contribuyente" {% if paciente and paciente.tipo_vinculacion == 'Contribuyente' %}selected{% endif %}>Contribuyente</option>
                        <option value="Beneficiario" {% if paciente and paciente.tipo_vinculacion == 'Beneficiario' %}selected{% endif %}>Beneficiario</option>
                        <option value="Subsidiado" {% if paciente and paciente.tipo_vinculacion == 'Subsidiado' %}selected{% endif %}>Subsidiado</option>
                    </select>
                </div>
                {{ render_campo('Ocupaci√≥n', 'ocupacion', paciente) }}
            </div>
        </div>
    </div>
</div> 

<!-- ======================================================================= -->
<!-- _accordion_registro_paciente.html (VERSI√ìN FINAL Y CORREGIDA) -->
<!-- ======================================================================= -->

<!-- ... (Aqu√≠ ir√≠an tus otros acordeones como "Datos Personales", etc.) ... -->

<!-- =========== SECCI√ìN 1.5: INFORMACI√ìN PARA RIPS (CON L√ìGICA DE SELECCI√ìN) =========== -->
<div class="accordion-item card-custom mb-3">
    <h2 class="accordion-header" id="headingRIPS">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRIPS" aria-expanded="false" aria-controls="collapseRIPS">
            <i data-lucide="clipboard-check" class="accordion-icon"></i>
            <strong>Informaci√≥n RIPS</strong>
        </button>
    </h2>
    <div id="collapseRIPS" class="accordion-collapse collapse show" aria-labelledby="headingRIPS" data-bs-parent="#accordionRegistroPaciente">
        <div class="accordion-body">
            <div class="alert alert-info" role="alert">
                <i data-lucide="info" style="width: 16px; height: 16px;"></i>
                <small>Esta informaci√≥n es necesaria para generar los archivos RIPS.</small>
            </div>
            
            <!-- Fila 1: EPS, Tipo Usuario, Condici√≥n -->
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label for="codigo_aseguradora" class="form-label">EPS/Aseguradora <span class="text-danger">*</span></label>
                    <select class="form-select" id="codigo_aseguradora" name="codigo_aseguradora" required>
                        <option value="">Seleccione una EPS</option>
                        {% for eps in eps_list %}
                            <option value="{{ eps.codigo }}" {% if paciente.codigo_aseguradora == eps.codigo %}selected{% endif %}>
                                {{ eps.codigo }} - {{ eps.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="tipo_usuario_rips" class="form-label">Tipo de Usuario</label>
                    <select class="form-select" id="tipo_usuario_rips" name="tipo_usuario_rips">
                        <option value="">Seleccione</option>
                        <option value="1" {% if paciente.tipo_usuario_rips == '1' %}selected{% endif %}>1 - Contributivo</option>
                        <option value="2" {% if paciente.tipo_usuario_rips == '2' %}selected{% endif %}>2 - Subsidiado</option>
                        <option value="3" {% if paciente.tipo_usuario_rips == '3' %}selected{% endif %}>3 - Vinculado</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="tipo_afiliado" class="form-label">Condici√≥n (Afiliado)</label>
                    <select class="form-select" id="tipo_afiliado" name="tipo_afiliado">
                        <option value="">Seleccione</option>
                        <option value="C" {% if paciente.tipo_afiliado == 'C' %}selected{% endif %}>Cotizante</option>
                        <option value="B" {% if paciente.tipo_afiliado == 'B' %}selected{% endif %}>Beneficiario</option>
                    </select>
                </div>
            </div>

            <!-- Fila 2: Zona, Departamento, Municipio -->
            <div class="row g-3 mb-3">
                 <div class="col-md-4">
                    <label for="zona_residencial" class="form-label">Zona de Residencia <span class="text-danger">*</span></label>
                    <select class="form-select" id="zona_residencial" name="zona_residencial" required>
                        <option value="U" {% if not paciente.zona_residencial or paciente.zona_residencial == 'U' %}selected{% endif %}>Urbano</option>
                        <option value="R" {% if paciente.zona_residencial == 'R' %}selected{% endif %}>Rural</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="codigo_departamento" class="form-label">Departamento <span class="text-danger">*</span></label>
                    <select class="form-select" id="codigo_departamento" name="codigo_departamento" required>
                        <option value="">Seleccione un departamento</option>
                        {% for depto in departamentos_list %}
                            <option value="{{ depto.codigo }}" {% if paciente.codigo_departamento == depto.codigo %}selected{% endif %}>
                                {{ depto.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="codigo_municipio" class="form-label">Municipio <span class="text-danger">*</span></label>
                    <select class="form-select" id="codigo_municipio" name="codigo_municipio" required disabled>
                        <option value="">Primero seleccione un departamento</option>
                    </select>
                </div>
            </div>
            
            <!-- ... (Aqu√≠ ir√≠an el resto de tus acordeones) ... -->

        </div>
    </div>
</div>
    <!-- =========== SECCI√ìN 2: DATOS DEL RESPONSABLE =========== -->
    <div class="accordion-item card-custom mb-3">
        <h2 class="accordion-header" id="headingResponsable">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseResponsable" aria-expanded="false" aria-controls="collapseResponsable">
                <i data-lucide="shield" class="accordion-icon"></i>
                <strong>Datos del Responsable</strong>
            </button>
        </h2>
        {# data-bs-parent apunta al ID del primer accordion-item. #}
        <div id="collapseResponsable" class="accordion-collapse collapse" aria-labelledby="headingResponsable" data-bs-parent="#accordionRegistroPaciente">
            <div class="accordion-body">
                <div class="row mb-3">
                    {{ render_campo('Nombre del Responsable', 'nombre_responsable', paciente) }}
                    {{ render_campo('Tel√©fono del Responsable', 'telefono_responsable', paciente) }}
                    {{ render_campo('Parentesco', 'parentesco', paciente) }}
                    {{ render_campo('Referido por', 'referido_por', paciente) }}
                </div>
            </div>
        </div>
    </div> 
    
    <!-- =========== SECCI√ìN 3: ANTECEDENTES PERSONALES =========== -->
    <div class="accordion-item card-custom mb-3">
        <h2 class="accordion-header" id="headingAntecedentes">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAntecedentes" aria-expanded="false" aria-controls="collapseAntecedentes">
                <i data-lucide="file-text" class="accordion-icon"></i>
                <strong>Antecedentes Personales</strong>
            </button>
        </h2>
        {# data-bs-parent apunta al ID del primer accordion-item. #}
        <div id="collapseAntecedentes" class="accordion-collapse collapse" aria-labelledby="headingAntecedentes" data-bs-parent="#accordionRegistroPaciente">
            <div class="accordion-body">
                <div class="row">
                    {{ render_campo_textarea('Motivo de Consulta', 'motivo_consulta', paciente) }}
                    {{ render_campo_textarea('Enfermedad Actual', 'enfermedad_actual', paciente) }}
                    {{ render_campo_textarea('Antecedentes Personales', 'antecedentes_personales', paciente) }}
                    {{ render_campo_textarea('Antecedentes Familiares', 'antecedentes_familiares', paciente) }}
                    {{ render_campo_textarea('Antecedentes Quir√∫rgicos', 'antecedentes_quirurgicos', paciente) }}
                    {{ render_campo_textarea('Antecedentes Hemorr√°gicos', 'antecedentes_hemorragicos', paciente) }}
                    {{ render_campo_textarea('Farmacol√≥gicos', 'farmacologicos', paciente) }}
                    {{ render_campo_textarea('Reacci√≥n a Medicamentos', 'reaccion_medicamentos', paciente) }}
                    {{ render_campo_textarea('Alergias', 'alergias', paciente) }}
                    {{ render_campo_textarea('H√°bitos', 'habitos', paciente) }}
                    {{ render_campo_textarea('Cepillado', 'cepillado', paciente) }}
                    {{ render_campo_textarea('Examen F√≠sico', 'examen_fisico', paciente) }}
                    {{ render_campo_textarea('√öltima Visita al Odont√≥logo', 'ultima_visita_odontologo', paciente) }}
                    {{ render_campo_textarea('Plan de Tratamiento', 'plan_tratamiento', paciente) }}
                    {{ render_campo_textarea('Observaciones', 'observaciones', paciente) }}
                </div>
            </div>
        </div> 
    </div>
<!-- =========== SECCI√ìN 4: DENTIGRAMA =========== -->
    <div class="accordion-item card-custom mb-3" id="dentigramaAccordionItem"> {# <-- ¬°NUEVO ID AQU√ç! #}
        <h2 class="accordion-header" id="headingDentigrama">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDentigrama" aria-expanded="false" aria-controls="collapseDentigrama">
                <i data-lucide="image" class="accordion-icon"></i>
                <strong>Dentigrama</strong>
            </button>
        </h2>
        <div id="collapseDentigrama" class="accordion-collapse collapse" aria-labelledby="headingDentigrama" data-bs-parent="#accordionRegistroPaciente">
            <div class="accordion-body">
                <div id="dentigrama-container" 
                    style="position: relative; 
                            width: 800px; 
                            height: 413px; 
                            margin: 0 auto; 
                            border: 1px solid #ccc; 
                            background-image: url('{{ url_for('static', filename='img/plantilla_dentigrama.png') }}'); 
                            background-size: cover; 
                            background-repeat: no-repeat; 
                            background-position: center; 
                            z-index: 0;">
                    
                    <canvas id="dentigrama_canvas" 
                            style="position: absolute; 
                                top: 0; 
                                left: 0; 
                                width: 100%; 
                                height: 100%; 
                                background-color: transparent; 
                                z-index: 10; 
                                pointer-events: auto;"></canvas>

                    {# Aseg√∫rate de que el dentigrama_overlay_src est√© presente si es para edici√≥n #}
                    {% if paciente and paciente.dentigrama_canvas %}
                        <img id="dentigrama_overlay_src" src="{{ paciente.dentigrama_canvas }}" style="display: none;">
                    {% else %}
                        {# Si no hay dentigrama_canvas en el paciente, aseg√∫rate de que el src est√© vac√≠o o un placeholder #}
                        <img id="dentigrama_overlay_src" src="" style="display: none;">
                    {% endif %}
                </div>

                <div class="mt-3 text-center dentigrama-controls">
                    <button type="button" class="btn btn-light btn-sm" id="btnColorRojo">üî¥ Rojo</button>
                    <button type="button" class="btn btn-light btn-sm" id="btnColorAzul">üîµ Azul</button>
                    <button type="button" class="btn btn-light btn-sm" id="btnColorNegro">‚ö´ Negro</button>
                    <button type="button" class="btn btn-light btn-sm" id="btnActivarCheck">‚úîÔ∏è Check</button>
                    <span class="mx-2">/</span>
                    <button type="button" class="btn btn-warning btn-sm" id="btnLimpiar">üßπ Limpiar</button>
                    <button type="button" class="btn btn-info btn-sm" id="btnDeshacer">‚Ü©Ô∏è Deshacer</button>
                    <span class="mx-2">/</span>
                    <button type="button" class="btn btn-primary" id="btnGuardarDentigrama">üíæ Aplicar Cambios al Dentigrama</button>
                </div>
                
                <!-- Input oculto para la URL de Cloudinary -->
                <input type="hidden" name="dentigrama_canvas" id="dentigrama_url_input" value="{{ paciente.dentigrama_canvas or '' }}">

            </div>
        </div>
    </div>


    <!-- =========== SECCI√ìN 5: IM√ÅGENES DEL PACIENTE =========== -->
    <div class="accordion-item card-custom mb-3">
        <h2 class="accordion-header" id="headingImagenes">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseImagenes" aria-expanded="false" aria-controls="collapseImagenes">
                <i data-lucide="image" class="accordion-icon"></i>
                <strong>Im√°genes del Paciente</strong>
            </button>
        </h2>
        <div id="collapseImagenes" class="accordion-collapse collapse" aria-labelledby="headingImagenes" data-bs-parent="#accordionRegistroPaciente">
            <div class="accordion-body">
                <div class="row">

                    <!-- === L√ìGICA PARA IMAGEN 1 === -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Imagen 1</label>
                        
                        {# Si la variable 'paciente' existe y tiene una URL, la mostramos #}
                        {% if paciente and paciente.imagen_1 %}
                            <div class="mb-2">
                                <img src="{{ paciente.imagen_1 }}" alt="Imagen 1 actual" class="img-fluid rounded border" style="max-height: 200px;">
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="eliminar_imagen_1" id="eliminar_imagen_1">
                                <label class="form-check-label" for="eliminar_imagen_1">
                                    Eliminar imagen 1 actual
                                </label>
                            </div>
                        {% else %}
                            <div class="alert alert-light p-2 text-center" role="alert">
                                No hay imagen subida.
                            </div>
                        {% endif %}
                        
                        <label for="imagen_1" class="form-label small text-muted mt-2">Subir nueva / Reemplazar</label>
                        <input type="file" class="form-control" id="imagen_1" name="imagen_1" accept="image/*">
                    </div>

                    <!-- === L√ìGICA PARA IMAGEN 2 === -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Imagen 2</label>
                        
                        {% if paciente and paciente.imagen_2 %}
                            <div class="mb-2">
                                <img src="{{ paciente.imagen_2 }}" alt="Imagen 2 actual" class="img-fluid rounded border" style="max-height: 200px;">
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="eliminar_imagen_2" id="eliminar_imagen_2">
                                <label class="form-check-label" for="eliminar_imagen_2">
                                    Eliminar imagen 2 actual
                                </label>
                            </div>
                        {% else %}
                            <div class="alert alert-light p-2 text-center" role="alert">
                                No hay imagen subida.
                            </div>
                        {% endif %}

                        <label for="imagen_2_url" class="form-label small text-muted mt-2">Subir nueva / Reemplazar</label>
                        <input type="file" class="form-control" id="imagen_2_url" name="imagen_2" accept="image/*">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =========== SECCI√ìN 6: GESTI√ìN DE EVOLUCIONES (S√ìLO SI EL PACIENTE YA EXISTE) =========== -->
    {% if paciente and paciente.id %}
        <div class="accordion-item card-custom mb-3">
            <h2 class="accordion-header" id="headingEvolucionesGestion">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEvolucionesGestion" aria-expanded="false" aria-controls="collapseEvolucionesGestion">
                    <i data-lucide="trending-up" class="accordion-icon"></i>
                    <strong>Gesti√≥n de Evoluciones</strong>
                </button>
            </h2>
            <div id="collapseEvolucionesGestion" class="accordion-collapse collapse" aria-labelledby="headingEvolucionesGestion" data-bs-parent="#accordionRegistroPaciente">
                <div class="accordion-body">
                    <h4 class="h6 mb-3">Historial de Evoluciones</h4>
                    <div class="evolucion-list mb-4" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px; background-color: #fcfcfc;">
                        {% if paciente.evoluciones %}
                            {% for evolucion in paciente.evoluciones | sort(attribute='fecha', reverse=True) %}
                            <div class="evolucion-item border-bottom pb-3 mb-3 d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="evolucion-date fw-bold text-primary small mb-1">{{ evolucion.fecha.strftime('%d de %B, %Y %H:%M') }}</div>
                                    <p class="evolucion-desc mb-0 text-muted">{{ evolucion.descripcion }}</p>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary"
                                            data-bs-toggle="modal" data-bs-target="#editEvolutionModal"
                                            data-evolution-id="{{ evolucion.id }}"
                                            data-evolution-descripcion="{{ evolucion.descripcion }}">
                                        Editar
                                    </button>
                                    <form action="{{ url_for('evoluciones.eliminar_evolucion', id=evolucion.id) }}" method="post" onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar esta evoluci√≥n?');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                                    </form>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-muted">No hay evoluciones registradas para este paciente.</p>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No hay evoluciones registradas para este paciente.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %} 

</div> {# CIERRE FINAL DEL div.accordion con id="accordionRegistroPaciente" #}

<!-- MODAL PARA EDITAR EVOLUCI√ìN (se mantiene aqu√≠, fuera de la condici√≥n del acorde√≥n) -->
<div class="modal fade" id="editEvolutionModal" tabindex="-1" aria-labelledby="editEvolutionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="editEvolutionForm" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEvolutionModalLabel">Editar Evoluci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="evolution_id" id="modalEvolutionId">
                    <div class="mb-3">
                        <label for="modalEvolutionDescripcion" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="modalEvolutionDescripcion" name="descripcion" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>



