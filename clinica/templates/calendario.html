{% extends "base.html" %}

{% block title %}Calendario - Clínica{% endblock %}

{% block head_extra %}
    <style>
        /* --- ESTILOS TIPO IOS LIGHT --- */
        
        /* Contenedor principal limpio */
        .ios-calendar-container {
            background-color: #ffffff;
            /* En móvil quitamos bordes y sombras para que parezca nativo */
            border-radius: 0; 
            box-shadow: none;
        }
        
        /* En pantallas grandes mantenemos el estilo Glass */
        @media (min-width: 768px) {
            .ios-calendar-container {
                border-radius: 2.5rem;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
                border: 1px solid rgba(0,0,0,0.05);
                padding: 2rem;
            }
        }

        /* Título del Mes Gigante */
        .month-title {
            font-size: 2.2rem;
            font-weight: 800;
            color: #000;
            letter-spacing: -0.02em;
            line-height: 1;
        }
        .year-subtitle {
            font-size: 1rem;
            color: #6b7280; 
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        /* --- GRILLA LIMPIA --- */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            /* CERO espacio entre celdas */
            width: 100%;
        }

        /* Cabecera de días (D L M...) */
        .day-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af; /* Gris suave */
            text-transform: uppercase;
            padding-bottom: 1rem;
            padding-top: 1rem;
            border-bottom: 1px solid #f3f4f6; /* Línea separadora muy sutil */
        }

        /* Celda del día */
        .day-cell {
            height: 85px; /* Altura fija para uniformidad */
            border-bottom: 1px solid #f3f4f6; /* Solo líneas horizontales muy sutiles */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center; /* Todo centrado horizontalmente */
            padding-top: 8px;
        }
        
        /* Número del día */
        .day-number {
            font-size: 1.1rem;
            font-weight: 500;
            color: #000;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-bottom: 4px;
            transition: all 0.2s;
        }

        /* Día Actual (Estilo iOS Rojo) */
        .day-cell.today .day-number {
            background-color: #000; /* Rojo iOS */
            color: #fff;
            font-weight: 700;
        }

        /* Eventos / Citas (Píldoras) */
        .event-pill {
            font-size: 0.65rem;
            background-color: #ecfccb; /* Verde muy claro */
            color: #365314; /* Verde oscuro texto */
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 2px;
            width: 90%; /* Que no toque los bordes */
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-left: 2px solid #65a30d; /* Borde izquierdo de acento */
            cursor: pointer;
        }
        
        /* Si hay muchas citas, mostramos puntos */
        .dots-container {
            display: flex;
            gap: 2px;
            justify-content: center;
        }
        .dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #9ca3af;
        }
        .day-cell.today .dot { background-color: #ef4444; }

        /* Botón + Invisible pero clicable */
        .add-hitbox {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1; /* Fondo */
        }
        
        /* Selectores tipo iOS */
        .ios-select {
            border: none;
            background: transparent;
            font-size: 1.2rem;
            font-weight: 600;
            color: #000;
            padding-right: 1.5rem;
            cursor: pointer;
            appearance: none;
        }
        
    </style>
{% endblock %}

{% block content %}

<!-- Contenedor Base -->
<div class="relative min-h-screen bg-white md:bg-gray-100 overflow-x-hidden font-sans pb-24">
    
    <!-- Elementos Decorativos (Solo visibles en Desktop para no ensuciar móvil) -->
    <div class="hidden md:block absolute top-0 left-0 w-96 h-96 bg-gray-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob"></div>

    <div class="relative z-10 w-full max-w-5xl mx-auto md:p-6">
        
        <!-- Panel Principal -->
        <div class="ios-calendar-container">
            
            <!-- Encabezado Estilo iOS -->
            <div class="px-4 pt-4 pb-2 flex justify-between items-end mb-2">
                <div>
                    <!-- Año -->
                    <div class="year-subtitle">{{ anio }}</div>
                    
                    <!-- Título Mes y Flechas -->
                    <div class="flex items-center gap-1">
                        <h1 class="month-title mr-2">{{ nombre_mes_display|capitalize }}</h1>
                        
                        <!-- Flecha ATRÁS (Nueva) -->
                        <form method="GET" action="{{ url_for('calendario.mostrar_calendario') }}" class="flex">
                            {% set prev_month = mes - 1 if mes > 1 else 12 %}
                            {% set prev_year = anio if mes > 1 else anio - 1 %}
                            <input type="hidden" name="mes" value="{{ prev_month }}">
                            <input type="hidden" name="anio" value="{{ prev_year }}">
                            <button type="submit" class="text-gray-400 hover:text-black transition p-1">
                                <i data-lucide="chevron-left" class="w-8 h-8"></i>
                            </button>
                        </form>

                        <!-- Flecha ADELANTE -->
                        <form method="GET" action="{{ url_for('calendario.mostrar_calendario') }}" class="flex">
                            {% set next_month = mes + 1 if mes < 12 else 1 %}
                            {% set next_year = anio if mes < 12 else anio + 1 %}
                            <input type="hidden" name="mes" value="{{ next_month }}">
                            <input type="hidden" name="anio" value="{{ next_year }}">
                            <button type="submit" class="text-gray-400 hover:text-black transition p-1">
                                <i data-lucide="chevron-right" class="w-8 h-8"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="flex gap-3 mb-1">
                    <a href="{{ url_for('main.index') }}" class="p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200">
                        <i data-lucide="home" class="w-5 h-5"></i>
                    </a>
                    <!-- Botón Más (+) ahora en NEGRO -->
                    <a href="{{ url_for('calendario.registrar_cita') }}" class="p-2 rounded-full bg-black text-white shadow-md hover:bg-gray-800">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </a>
                </div>
            </div>

            <!-- Separador de Meses (Selectores ocultos/sutiles para cambiar rápido) -->
            <form method="get" action="{{ url_for('calendario.mostrar_calendario') }}" class="px-4 mb-4 flex gap-4 text-sm text-gray-400">
                <div class="flex items-center gap-2">
                    <span>Ir a:</span>
                    <select name="mes" class="bg-transparent border-b border-gray-200 focus:border-red-500 outline-none text-gray-800 font-medium" onchange="this.form.submit()">
                        {% for m in range(1, 13) %}
                            <option value="{{ m }}" {% if m == mes %}selected{% endif %}>{{ nombres_meses[m-1] }}</option>
                        {% endfor %}
                    </select>
                    <select name="anio" class="bg-transparent border-b border-gray-200 focus:border-red-500 outline-none text-gray-800 font-medium" onchange="this.form.submit()">
                        {% for a in range(anio - 2, anio + 3) %}
                            <option value="{{ a }}" {% if a == anio %}selected{% endif %}>{{ a }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>

            <!-- CABECERA DÍAS SEMANA (Minimalista) -->
            <div class="calendar-grid sticky top-0 bg-white z-20">
                <div class="day-header">D</div>
                <div class="day-header">L</div>
                <div class="day-header">M</div>
                <div class="day-header">M</div>
                <div class="day-header">J</div>
                <div class="day-header">V</div>
                <div class="day-header">S</div>
            </div>

            <!-- CUERPO DEL CALENDARIO -->
            <div class="calendar-grid">
                {% for dia in dias %}
                    <!-- Celda -->
                    <div class="day-cell {% if dia.hoy %}today{% endif %}">
                        
                        {% if dia.fecha %}
                            <!-- Número (Centrado y redondo) -->
                            <span class="day-number">{{ dia.fecha.day }}</span>

                            <!-- Área Clicable para añadir cita (Ocupa el fondo) -->
                            <a href="{{ url_for('calendario.registrar_cita', fecha=dia.fecha.strftime('%Y-%m-%d'), next=request.full_path) }}" 
                               class="add-hitbox" title="Añadir Cita"></a>

                            <!-- INDICADORES DE CITAS (Píldoras o Puntos) -->
                            {% if dia.citas %}
                                <div class="w-full px-1 flex flex-col gap-1 items-center z-20 pointer-events-none"> <!-- z-20 para estar sobre el hitbox -->
                                    
                                    <!-- Opción A: Si hay pocas citas (1 o 2), mostrar píldoras con nombre -->
                                    {% if dia.citas|length <= 2 %}
                                        {% for cita in dia.citas %}
                                            <!-- Usamos un botón invisible sobre la píldora para abrir el modal -->
                                            <div class="relative w-full">
                                                <div class="event-pill">
                                                    {{ cita.hora }} {{ cita.paciente_nombre_completo.split()[0] }}
                                                </div>
                                                <button class="absolute inset-0 w-full h-full cursor-pointer pointer-events-auto"
                                                        data-bs-toggle="modal" data-bs-target="#modalCitas"
                                                        data-fecha="{{ dia.fecha.strftime('%Y-%m-%d') }}"
                                                        data-citas="{{ dia.citas|tojson|e }}">
                                                </button>
                                            </div>
                                        {% endfor %}
                                    
                                    <!-- Opción B: Si hay muchas citas, mostrar puntos o contador -->
                                    {% else %}
                                        <div class="relative w-full">
                                            <div class="event-pill bg-gray-100 text-gray-600 border-l-4 border-gray-400 text-center font-bold">
                                                {{ dia.citas|length }} Citas
                                            </div>
                                            <button class="absolute inset-0 w-full h-full cursor-pointer pointer-events-auto"
                                                    data-bs-toggle="modal" data-bs-target="#modalCitas"
                                                    data-fecha="{{ dia.fecha.strftime('%Y-%m-%d') }}"
                                                    data-citas="{{ dia.citas|tojson|e }}">
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}

                        {% endif %}
                    </div>
                {% endfor %}
            </div>

        </div>
    </div>
</div>

<!-- Modal de Citas (Estilo iOS Sheet) -->
<div class="modal fade" id="modalCitas" tabindex="-1" aria-labelledby="modalCitasLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-[2rem] border-none shadow-2xl">
            <div class="modal-header border-b-0 pb-0">
                <h5 class="modal-title font-bold text-2xl text-gray-900" id="modalCitasLabel">Detalles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-5">
                <div id="citas-lista-modal" class="space-y-3">
                    <!-- Aquí se inyectan las citas -->
                </div>
            </div>
            <div class="modal-footer border-t-0 pt-0">
                <button type="button" class="w-full bg-gray-100 text-black font-bold py-3 rounded-xl hover:bg-gray-200 transition" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script> 
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();

            const modalCitas = document.getElementById('modalCitas');
            if (modalCitas) {
                modalCitas.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget; 
                    const fechaStr = button.getAttribute('data-fecha');
                    const citasJson = button.getAttribute('data-citas');

                    let citas = [];
                    try {
                        citas = JSON.parse(citasJson); 
                    } catch (e) {
                        console.error("Error JSON:", e);
                        return;
                    }

                    const modalTitle = modalCitas.querySelector('#modalCitasLabel');
                    const fechaObj = new Date(fechaStr + 'T00:00:00');
                    // Título estilo iOS: "Viernes, 28 de Noviembre"
                    modalTitle.textContent = fechaObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                    modalTitle.style.textTransform = 'capitalize';

                    const citasListaModal = modalCitas.querySelector('#citas-lista-modal');
                    citasListaModal.innerHTML = ''; 

                    if (citas.length > 0) {
                        citas.sort((a, b) => (a.hora < b.hora ? -1 : 1));                        
                        citas.forEach(cita => {
                            const citaDiv = document.createElement('div');
                            // Tarjeta de cita en Modal
                            citaDiv.className = 'flex items-center gap-4 bg-white p-3 rounded-2xl border border-gray-100 shadow-sm';
                            
                            citaDiv.innerHTML = `
                                <div class="flex-shrink-0 w-12 text-center">
                                    <span class="block text-sm font-bold text-gray-900">${cita.hora}</span>
                                </div>
                                <div class="border-l-2 border-red-500 h-8 mx-2"></div>
                                <div class="flex-grow">
                                    <p class="font-bold text-gray-900 text-sm">${cita.paciente_nombre_completo}</p>
                                    <p class="text-xs text-gray-500">${cita.motivo || 'Consulta General'}</p>
                                </div>
                                <a href="${cita.edit_url}" class="text-gray-400 hover:text-black">
                                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                </a>
                            `;
                            citasListaModal.appendChild(citaDiv);
                        });
                        lucide.createIcons();
                    }
                });
            }
        });
    </script>
{% endblock %}