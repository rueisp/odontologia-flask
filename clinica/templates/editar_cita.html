{% extends "base.html" %}
{% block title %}Editar Cita{% endblock %}

{% block content %}
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">

        <h2 class="text-3xl font-bold mb-6 text-gray-800">Editar Cita</h2>
        
        <form method="POST" 
              action="{{ url_for('calendario.editar_cita', cita_id=cita.id, next=form_data.next_url if form_data and form_data.next_url else request.args.get('next')) }}">
            
            {# Campo oculto para 'next' para asegurar que se reenvíe en POST #}
            {% if form_data and form_data.next_url %}
                <input type="hidden" name="next" value="{{ form_data.next_url }}">
            {% elif request.args.get('next') %}
                <input type="hidden" name="next" value="{{ request.args.get('next') }}">
            {% endif %}

            {# Usaremos un grid para un mejor diseño de formulario #}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-2">
                    <label for="paciente_id" class="block text-gray-700 text-sm font-bold mb-2">Paciente:</label>
                    <select name="paciente_id" id="paciente_id" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for paciente_opt in pacientes %} 
                            <option value="{{ paciente_opt.id }}" 
                                    {% if (form_data and form_data.selected_paciente_id and paciente_opt.id == form_data.selected_paciente_id|int) or (paciente_opt.id == cita.paciente_id) %}
                                        selected
                                    {% endif %}>
                                {{ paciente_opt.nombres }} {{ paciente_opt.apellidos }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="fecha" class="block text-gray-700 text-sm font-bold mb-2">Fecha:</label>
                    <input type="date" name="fecha" id="fecha" 
                           value="{{ form_data.fecha_val if form_data and form_data.fecha_val is not none else cita.fecha.strftime('%Y-%m-%d') }}" 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>

                <div>
                    <label for="hora" class="block text-gray-700 text-sm font-bold mb-2">Hora:</label>
                    <input type="time" name="hora" id="hora" 
                           value="{{ form_data.hora_val if form_data and form_data.hora_val is not none else cita.hora.strftime('%H:%M') }}" 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>

            <div class="mt-6">
                <label for="doctor" class="block text-gray-700 text-sm font-bold mb-2">Doctor:</label>
                <input type="text" name="doctor" id="doctor" 
                       value="{{ form_data.doctor_val if form_data and form_data.doctor_val is not none else cita.doctor }}" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>

            <div class="mt-6">
                <label for="motivo" class="block text-gray-700 text-sm font-bold mb-2">Motivo:</label>
                <input type="text" name="motivo" id="motivo" 
                       value="{{ form_data.motivo_val if form_data and form_data.motivo_val is not none else (cita.motivo or '') }}" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="mt-6">
                <label for="observaciones" class="block text-gray-700 text-sm font-bold mb-2">Observaciones:</label>
                <textarea name="observaciones" id="observaciones" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3">{{ form_data.observaciones_val if form_data and form_data.observaciones_val is not none else (cita.observaciones or '') }}</textarea>
            </div>
            
            <!-- =================================================================== -->
            <!-- ▼▼▼ NUEVA SECCIÓN DE PROCEDIMIENTOS INTEGRADA AQUÍ ▼▼▼ -->
            <!-- =================================================================== -->
            <div class="mt-8 pt-6 border-t">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Procedimientos Realizados</h3>
                    <a href="{{ url_for('procedimientos.registrar_procedimiento', cita_id=cita.id) }}"
                       class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700 transition gap-2">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        Añadir
                    </a>
                </div>
                
                <div class="space-y-3">
                    {% for proc in cita.procedimientos %}
                        <div class="bg-gray-50 border rounded-lg p-3 flex justify-between items-center text-sm">
                            <div>
                                <p class="font-semibold text-gray-700">{{ proc.codigo_cups }} - <span class="font-normal text-gray-600">{{ proc.descripcion or 'Sin descripción' }}</span></p>
                                <p class="text-xs text-gray-500 mt-1">Diagnóstico: {{ proc.diagnostico_cie10 }}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-gray-800">${{ "{:,.0f}".format(proc.valor) | replace(',', '.') }}</p>
                                <!-- Futuro botón de eliminar procedimiento -->
                            </div>
                        </div>
                    {% else %}
                        <p class="text-gray-500 text-center py-4 border-dashed border-2 rounded-lg">No hay procedimientos registrados para esta cita.</p>
                    {% endfor %}
                </div>
            </div>
            <!-- =================================================================== -->
            <!-- ▲▲▲ FIN DE LA SECCIÓN DE PROCEDIMIENTOS ▲▲▲ -->
            <!-- =================================================================== -->

            <div class="mt-8 pt-6 border-t flex justify-between items-center">
                {# Botón Cancelar ahora usa la lógica de 'next_url' #}
                <a href="{{ (form_data.next_url if form_data and form_data.next_url else request.args.get('next')) or url_for('calendario.mostrar_calendario') }}" 
                   class="text-sm font-medium text-gray-600 hover:text-gray-900">Cancelar</a>
                <button type="submit" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-lg transition">
                    Guardar Cambios
                </button>
            </div>
        </form>
        
        {# He movido el botón de eliminar aquí, más integrado #}
        <div class="mt-6 text-center">
             <form action="{{ url_for('calendario.eliminar_cita', cita_id=cita.id) }}" method="POST" 
                  onsubmit="return confirm('¿Estás seguro de que deseas mover esta cita a la papelera?');" class="inline">
                {# Campo oculto para 'next' para que sepa a dónde volver #}
                <input type="hidden" name="next" value="{{ (form_data.next_url if form_data and form_data.next_url else request.args.get('next')) or url_for('pacientes.lista_pacientes') }}">
                
                <button type="submit" class="text-sm text-red-600 hover:text-red-800 hover:underline">
                    Mover a la papelera
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}