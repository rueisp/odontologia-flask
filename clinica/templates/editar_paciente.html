{% extends "base.html" %}

{% from '_componentes_paciente.html' import render_campo, render_campo_textarea %}

{% block title %}Editar Paciente - {{ paciente.nombres }} {{ paciente.apellidos }}{% endblock %}

{% block head_extra %}
{% endblock %}

{% block content %}
<div class="container mt-4">

    <div class="edit-header text-center mb-4">
        <h1>Editando Perfil</h1>
        <p>Paciente: <strong>{{ paciente.nombres }} {{ paciente.apellidos }}</strong> (ID: {{ paciente.id }})</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div id="flash-message-container" class="mt-3">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    <form action="{{ url_for('pacientes.editar_paciente', id=paciente.id) }}" method="POST" enctype="multipart/form-data" id="patientEditForm">
        

        {# Mantenemos el include del acordeón, ya que usa las macros render_campo/textarea #}
        {# Si después de este cambio, los campos del acordeón sí se llenan, el problema es en la macro render_campo #}
        {% include '_accordion_registro_paciente.html' with context %}
        
        <div class="mt-5 mb-5 d-flex gap-3 justify-content-center">
            <button type="submit" class="btn btn-dark" id="editSaveButton">Guardar Cambios</button>
            <a href="{{ url_for('pacientes.mostrar_paciente', id=paciente.id) }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}


{% block scripts %}
    <!-- Script para mostrar el mensaje flash como alert (consolidado) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const flashContainer = document.getElementById("flash-message-container");
                if (flashContainer) {
                    // ... tu lógica de mensajes flash ...
                }
            } catch (e) { console.error("ERROR en Flash Message Script:", e); }
        });
    </script>

    
    {# Este script debe cargarse ANTES del script principal de la página, si depende de él #}
    <script src="{{ url_for('static', filename='js/editor_dentigrama.js') }}"></script> 
    
    {# ¡INCLUIR TU SCRIPT DE AVATAR UPLOAD AQUI! #}
    <script src="{{ url_for('static', filename='js/avatar_upload.js') }}"></script> 

    <script>
        // Este es tu script principal de la página
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log("EDIT PAGE SCRIPT: DOMContentLoaded fired from editar_paciente.html."); 
                
                // --- Inicialización de Lucide Icons ---
                // ¡COMENTA O ELIMINA ESTA LÍNEA! Ya se llama en base.html
                // lucide.createIcons();

                // --- Lógica para el cálculo de la edad ---
                const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
                const edadInput = document.getElementById('edad');

                if (fechaNacimientoInput && edadInput) { 
                    fechaNacimientoInput.addEventListener('change', function () {
                        const fechaNacimiento = new Date(this.value);
                        const hoy = new Date();

                        let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
                        const mes = hoy.getMonth() - fechaNacimiento.getMonth();

                        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
                            edad--;
                        }
                        edadInput.value = edad;
                        console.log("EDIT PAGE SCRIPT: Edad calculada:", edad);
                    });
                    // También calcula la edad al cargar si ya hay una fecha de nacimiento (como string 'YYYY-MM-DD')
                    if (fechaNacimientoInput.value) {
                         fechaNacimientoInput.dispatchEvent(new Event('change'));
                    }
                } else {
                    console.warn("EDIT PAGE SCRIPT WARNING: No se encontraron los inputs de Fecha de Nacimiento o Edad. ID's esperados: 'fecha_nacimiento', 'edad'.");
                }
                // --- FIN Lógica para el cálculo de la edad ---

                // --- Lógica para reinicializar el dentigrama cuando su acordeón se abre ---
                const dentigramaCollapseElement = document.getElementById('collapseDentigrama');
                if (dentigramaCollapseElement) {
                    dentigramaCollapseElement.addEventListener('shown.bs.collapse', function () {
                        console.log("EDIT PAGE SCRIPT: Acordeón del dentigrama abierto. Reinicializando dentigrama...");
                        if (typeof window.initializeDentigram === 'function') {
                            window.initializeDentigram(); // Llama a la función global sin argumentos
                        } else {
                            console.error("EDIT PAGE SCRIPT ERROR: window.initializeDentigram no está disponible globalmente.");
                        }
                    });
                } else {
                    console.warn("EDIT PAGE SCRIPT WARNING: No se encontró el elemento del acordeón del dentigrama con ID 'collapseDentigrama'.");
                }
                // --- FIN Lógica de reinicialización del dentigrama ---



                // --- Lógica del formulario principal de paciente (CORREGIDA PARA NO DUPLICAR SUBIDA DE DENTIGRAMA) ---
                const patientEditForm = document.getElementById('patientEditForm');
                const editSaveButton = document.getElementById('editSaveButton'); 
                const dentigramaUrlInput = document.getElementById('dentigrama_url_input');

                if (patientEditForm && editSaveButton) {
                    console.log("EDIT PAGE SCRIPT: patientEditForm and editSaveButton found.");
                    
                    const editSaveButtonHandler = async function(event) { 
                        event.preventDefault(); 
                        console.log("EDIT PAGE SCRIPT: Save button CLICK event detected. Starting save process.");

                        editSaveButton.disabled = true;
                        editSaveButton.textContent = 'Guardando Cambios...';
                        
                        try {
                            let finalDentigramUrl = dentigramaUrlInput.value; 
                            console.log("EDIT PAGE SCRIPT: finalDentigramUrl ANTES de enviar formulario:", finalDentigramUrl);

                            const formData = new FormData(patientEditForm); 
                            // Asegura que se envíe la URL correcta o vacía
                            formData.set('dentigrama_canvas', finalDentigramUrl || ''); // CORREGIDO: Usar 'dentigrama_canvas' si es el nombre de tu campo en el modelo/backend

                            console.log("EDIT PAGE SCRIPT: About to submit main form via fetch with dentigrama_canvas:", formData.get('dentigrama_canvas')); // CORREGIDO el log
                            
                            const response = await fetch(patientEditForm.action, {
                                method: patientEditForm.method, 
                                body: formData 
                            });

                            if (!response.ok) {
                                const errorText = await response.text(); 
                                throw new Error(`Error HTTP: ${response.status} - ${errorText || 'Error desconocido del servidor.'}`);
                            }

                            // Asumiendo que el backend responde con un mensaje o datos JSON
                            const result = await response.json(); 
                            console.log("EDIT PAGE SCRIPT: Server responded:", result);
                            alert(result.message || "Paciente actualizado exitosamente. Redirigiendo...");
                            
                            // Redirigir a la página de detalle del paciente después de editar
                            window.location.href = result.redirect_url || `{{ url_for('pacientes.mostrar_paciente', id=paciente.id) }}`; // Usa redirect_url de la respuesta si está disponible

                        } catch (error) {
                            console.error("EDIT PAGE SCRIPT ERROR: Error al actualizar el paciente:", error);
                            alert("Hubo un error al actualizar el paciente: " + error.message);
                        } finally {
                            editSaveButton.disabled = false;
                            editSaveButton.textContent = 'Guardar Cambios';
                        }
                    };
                    
                    // Remover y adjuntar el listener para evitar duplicados si el script se carga múltiples veces
                    editSaveButton.removeEventListener('click', editSaveButtonHandler);
                    editSaveButton.addEventListener('click', editSaveButtonHandler);
                    console.log("EDIT PAGE SCRIPT: Listener para 'editSaveButton' adjuntado/re-adjuntado.");

                } else {
                    console.error("EDIT PAGE SCRIPT ERROR: No se encontró el formulario principal con ID 'patientEditForm' o el botón 'editSaveButton'.");
                }
                // --- FIN Lógica del formulario principal de paciente para EDICIÓN ---


                // --- Lógica para el modal de editar evolución (se mantiene igual) ---
                var editEvolutionModal = document.getElementById('editEvolutionModal');
                if (editEvolutionModal) {
                    editEvolutionModal.addEventListener('show.bs.modal', function (event) {
                        var button = event.relatedTarget;
                        var evolutionId = button.getAttribute('data-evolution-id');
                        var evolutionDescripcion = button.getAttribute('data-evolution-descripcion');
                        
                        var modalEvolutionId = editEvolutionModal.querySelector('#modalEvolutionId');
                        var modalEvolutionDescripcion = editEvolutionModal.querySelector('#modalEvolutionDescripcion');
                        var editEvolutionForm = editEvolutionModal.querySelector('#editEvolutionForm');

                        modalEvolutionId.value = evolutionId;
                        modalEvolutionDescripcion.value = evolutionDescripcion;
                        editEvolutionForm.action = `{{ url_for('evoluciones.editar_evolucion', id=0) }}`.replace('0', evolutionId);
                    });
                }

            } catch (e) {
                console.error("ERROR FATAL en el script principal de editar_paciente.html:", e);
            }
        }); 
    </script>
{% endblock %}
