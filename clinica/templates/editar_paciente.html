{% extends "base.html" %}

{% from '_componentes_paciente.html' import render_campo, render_campo_textarea %}

{% block title %}Editar Paciente - {{ paciente.nombres }} {{ paciente.apellidos }}{% endblock %}

{% block content %}
<div class="container mt-4">

    <div class="edit-header text-center mb-4">
        <h1>Editando Perfil</h1>
        <p>Paciente: <strong>{{ paciente.nombres }} {{ paciente.apellidos }}</strong> (ID: {{ paciente.id }})</p>
    </div>

    {% include '_flash_messages.html' %} <!-- Incluimos los mensajes flash -->

    <form action="{{ url_for('pacientes.editar_paciente', id=paciente.id) }}" method="POST" enctype="multipart/form-data" id="patientEditForm">
        
        {% include '_accordion_registro_paciente.html' with context %}
        
        <div class="mt-5 mb-5 d-flex gap-3 justify-content-center">
            <button type="submit" class="btn btn-dark" id="editSaveButton">Guardar Cambios</button>
            <a href="{{ url_for('pacientes.mostrar_paciente', id=paciente.id) }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}


{% block scripts %}
    {{ super() }}

    <!-- Carga de scripts externos -->
    <script src="{{ url_for('static', filename='js/editor_dentigrama.js') }}"></script> 
    <script src="{{ url_for('static', filename='js/avatar_upload.js') }}"></script> 

    <!-- UN ÚNICO SCRIPT CON TODA LA LÓGICA PARA ESTA PÁGINA -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // --- Lógica de cálculo de edad ---
                const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
                const edadInput = document.getElementById('edad');
                if (fechaNacimientoInput && edadInput) { 
                    const calcularEdad = () => {
                        if (!fechaNacimientoInput.value) { edadInput.value = ''; return; }
                        const fechaNacimiento = new Date(fechaNacimientoInput.value);
                        const hoy = new Date();
                        let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
                        const mes = hoy.getMonth() - fechaNacimiento.getMonth();
                        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) edad--;
                        edadInput.value = edad >= 0 ? edad : '';
                    };
                    fechaNacimientoInput.addEventListener('change', calcularEdad);
                    calcularEdad(); // Calcula la edad al cargar la página
                }

                // --- Lógica del dentigrama ---
                const dentigramaCollapse = document.getElementById('collapseDentigrama');
                if (dentigramaCollapse) {
                    dentigramaCollapse.addEventListener('shown.bs.collapse', () => {
                        if (typeof window.initializeDentigram === 'function') window.initializeDentigram();
                    });
                }
                
                // --- Lógica de guardado del formulario principal ---
                const patientEditForm = document.getElementById('patientEditForm');
                const editSaveButton = document.getElementById('editSaveButton'); 
                if (patientEditForm && editSaveButton) {
                    editSaveButton.addEventListener('click', async (event) => { 
                        event.preventDefault(); 
                        editSaveButton.disabled = true;
                        editSaveButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
                        try {
                            const formData = new FormData(patientEditForm);
                            const response = await fetch(patientEditForm.action, { method: 'POST', body: formData });
                            const result = await response.json();
                            if (!response.ok) throw new Error(result.error || 'Error del servidor');
                            alert(result.message || "Paciente actualizado.");
                            if (result.redirect_url) window.location.href = result.redirect_url;
                        } catch (error) {
                            alert("Error al actualizar: " + error.message);
                        } finally {
                            editSaveButton.disabled = false;
                            editSaveButton.innerHTML = 'Guardar Cambios';
                        }
                    });
                }

                // --- Lógica de modal de evolución ---
                const editEvolutionModal = document.getElementById('editEvolutionModal');
                if (editEvolutionModal) {
                    editEvolutionModal.addEventListener('show.bs.modal', (event) => { /* Tu lógica de modal aquí */ });
                }

                // --- LÓGICA DE MUNICIPIOS DINÁMICOS ---
                const departamentoSelect = document.getElementById('codigo_departamento');
                const municipioSelect = document.getElementById('codigo_municipio');
                if (departamentoSelect && municipioSelect) {
                    const todosLosMunicipios = JSON.parse('{{ municipios_json | safe }}');
                    const municipioInicial = "{{ paciente.codigo_mpio or '' }}";
                    
                    const cargarMunicipios = (codigoDepto) => {
                        municipioSelect.innerHTML = '<option value="">Seleccione un municipio</option>';
                        municipioSelect.disabled = true;
                        if (!codigoDepto) return;
                        
                        const municipiosFiltrados = todosLosMunicipios.filter(m => m.codigo_departamento === codigoDepto);
                        if (municipiosFiltrados.length > 0) {
                            municipioSelect.disabled = false;
                            municipiosFiltrados.forEach(muni => {
                                const option = document.createElement('option');
                                option.value = muni.codigo;
                                option.textContent = muni.nombre;
                                if (muni.codigo === municipioInicial) {
                                    option.selected = true;
                                }
                                municipioSelect.appendChild(option);
                            });
                        }
                    };
                    departamentoSelect.addEventListener('change', () => cargarMunicipios(departamentoSelect.value));
                    if (departamentoSelect.value) {
                        cargarMunicipios(departamentoSelect.value);
                    }
                }
            } catch (e) {
                console.error("Error en el script de editar_paciente.html:", e);
            }
        }); 
    </script>
{% endblock %}