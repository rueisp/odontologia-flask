{% extends "base.html" %}

{% block title %}Registrar Cita{% endblock %}

{% block content %}

<!-- Contenedor Compacto: py-6 en vez de py-10, p-6 en vez de p-8 -->
<div class="relative w-full max-w-2xl mx-auto my-4 bg-white/95 backdrop-blur-xl rounded-[2rem] shadow-2xl p-6 border border-white/50">

    <!-- Encabezado Compacto (Horizontal) -->
    <div class="flex items-center justify-between mb-5 border-b border-gray-100 pb-3">
        <div class="flex items-center gap-3">
            <div class="flex items-center justify-center w-10 h-10 bg-gray-100 rounded-full">
                <i data-lucide="calendar-plus" class="w-5 h-5 text-black"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-900 leading-none">Nueva Cita</h2>
                <p class="text-xs text-gray-400 mt-1">Ingresa los datos del paciente y la cita</p>
            </div>
        </div>
        <!-- Botón cancelar discreto arriba a la derecha -->
        {% set cancel_url = form_values.get('next_url') or request.args.get('next') %}
        {% if not cancel_url %}
            {% set cancel_url = url_for('calendario.mostrar_calendario') %}
        {% endif %}
        <a href="{{ cancel_url }}" class="p-2 text-gray-400 hover:text-black transition-colors rounded-full hover:bg-gray-50">
            <i data-lucide="x" class="w-5 h-5"></i>
        </a>
    </div>

    <!-- Mensajes Flash Compactos -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div id="flash-message-container" class="mb-4 space-y-1">
            {% for category, message in messages %}
            <div class="px-4 py-2 rounded-xl text-sm flex items-center shadow-sm
                        {% if category == 'success' %} bg-green-50 text-green-800 border border-green-100
                        {% elif category == 'error' %} bg-red-50 text-red-800 border border-red-100
                        {% else %} bg-blue-50 text-blue-800 border border-blue-100 {% endif %}">
                <span class="font-medium">{{ message }}</span>
                <button type="button" class="ml-auto opacity-50 hover:opacity-100" data-bs-dismiss="alert"><i data-lucide="x" class="w-3 h-3"></i></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    <form method="POST" class="space-y-3" {# Espaciado vertical reducido #}
          action="{{ url_for('calendario.registrar_cita',
                             paciente_id_param=form_values.get('paciente_preseleccionado_id') if form_values else None,
                             next=form_values.get('next_url') if form_values else request.args.get('next')) }}">

        <input type="hidden" name="next" value="{{ form_values.get('next_url', request.args.get('next', '')) }}">
        <input type="hidden" id="paciente_id_seleccionado_hidden" name="paciente_id"
               value="{{ form_values.get('paciente_preseleccionado_id', '') }}">

        <!-- === PACIENTE === -->
        <div class="bg-gray-50/50 p-4 rounded-2xl border border-gray-100">
            <!-- Buscador Compacto -->
            <div class="relative group mb-3">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                </div>
                <input type="text" id="paciente_busqueda_input"
                       class="w-full pl-9 pr-3 py-2 bg-white border border-gray-200 rounded-xl text-sm text-gray-900 placeholder-gray-400 focus:ring-1 focus:ring-black focus:border-black transition-all outline-none"
                       placeholder="Buscar paciente..." autocomplete="off"
                       value="{{ form_values.get('paciente_preseleccionado_nombre', '') }}">
                <div id="sugerencias_citas" class="absolute z-20 w-full mt-1 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden hidden"></div>
            </div>
            
            <small class="block text-gray-400 text-[10px] mb-2" id="small_crear_nuevo_paciente">O llena los campos para crear uno nuevo:</small>

            <!-- FILA 1: Nombres (100% Ancho) -->
            <div class="mb-3">
                <input type="text" id="paciente_nombres" name="paciente_nombres_str" placeholder="Nombres *"
                       class="w-full px-3 py-2 bg-white border border-transparent rounded-xl text-sm focus:ring-1 focus:ring-black focus:bg-white disabled:bg-gray-100 transition-all outline-none shadow-sm placeholder-gray-500 text-gray-900"
                       value="{{ form_values.get('paciente_nombres_val', '') }}"
                       {% if form_values.get('paciente_preseleccionado_id') %}disabled{% else %}required{% endif %}>
            </div>
            
            <!-- FILA 2: Apellidos (100% Ancho) -->
            <div class="mb-3">
                <input type="text" id="paciente_apellidos" name="paciente_apellidos_str" placeholder="Apellidos *"
                       class="w-full px-3 py-2 bg-white border border-transparent rounded-xl text-sm focus:ring-1 focus:ring-black focus:bg-white disabled:bg-gray-100 transition-all outline-none shadow-sm placeholder-gray-500 text-gray-900"
                       value="{{ form_values.get('paciente_apellidos_val', '') }}"
                       {% if form_values.get('paciente_preseleccionado_id') %}disabled{% else %}required{% endif %}>
            </div>
            
            <!-- FILA 3: Teléfono (100% Ancho) -->
            <div class="mb-3">
                <input type="tel" id="paciente_telefono" name="paciente_telefono_str" placeholder="Número de Teléfono *"
                       class="w-full px-3 py-2 bg-white border border-transparent rounded-xl text-sm focus:ring-1 focus:ring-black disabled:bg-gray-100 transition-all outline-none shadow-sm placeholder-gray-500 text-gray-900"
                       value="{{ form_values.get('paciente_telefono_val', '') }}"
                       {% if form_values.get('paciente_preseleccionado_id') %}disabled{% else %}required{% endif %}>
            </div>

            <!-- FILA 4: Documento (Ancho) y Edad (Pequeño) -->
            <div class="grid grid-cols-3 gap-3">
                <!-- Documento ocupa 2 columnas -->
                <div class="col-span-2">
                    <input type="text" id="paciente_documento" name="paciente_documento_val" placeholder="Documento / DNI (Op.)"
                           class="w-full px-3 py-2 bg-white border border-transparent rounded-xl text-sm focus:ring-1 focus:ring-black disabled:bg-gray-100 transition-all outline-none shadow-sm placeholder-gray-500 text-gray-900"
                           value="{{ form_values.get('paciente_documento_val', '') }}"
                           {% if form_values.get('paciente_preseleccionado_id') %}disabled{% endif %}>
                </div>

                <!-- Edad ocupa 1 columna -->
                <div class="col-span-1">
                    <input type="number" id="paciente_edad" name="paciente_edad_val" placeholder="Edad" min="0"
                           class="w-full px-3 py-2 bg-white border border-transparent rounded-xl text-sm focus:ring-1 focus:ring-black disabled:bg-gray-100 transition-all outline-none shadow-sm placeholder-gray-500 text-gray-900 text-center"
                           value="{{ form_values.get('paciente_edad_val', '') }}"
                           {% if form_values.get('paciente_preseleccionado_id') %}disabled{% endif %}>
                </div>
            </div>
        </div>
        <!-- === CITA === -->
        <div class="grid grid-cols-2 gap-3">
            <!-- Fecha y Hora -->
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Fecha</label>
                <input type="date" name="fecha" id="fecha"
                       class="w-full px-3 py-2 bg-gray-50 border-none rounded-xl text-sm text-gray-900 font-medium focus:ring-1 focus:ring-black transition-all outline-none"
                       value="{{ form_values.get('fecha_val', request.args.get('fecha', '')) }}" required>
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Hora</label>
                <input type="time" name="hora" id="hora"
                       class="w-full px-3 py-2 bg-gray-50 border-none rounded-xl text-sm text-gray-900 font-medium focus:ring-1 focus:ring-black transition-all outline-none"
                       value="{{ form_values.get('hora_val', '') }}" required>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <!-- Doctor y Motivo en la misma línea -->
            <div class="relative">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Doctor</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none mt-6"> <!-- Icono ajustado -->
                        <i data-lucide="stethoscope" class="w-3 h-3 text-gray-400"></i>
                    </div>
                    <input type="text" name="doctor" id="doctor"
                           class="w-full pl-8 pr-3 py-2 bg-gray-50 border-none rounded-xl text-sm text-gray-900 focus:ring-1 focus:ring-black transition-all outline-none"
                           value="{{ form_values.get('doctor_val', '') }}"
                           placeholder="Dr. Nombre" required>
                </div>
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Motivo</label>
                <input type="text" name="motivo" id="motivo"
                       class="w-full px-3 py-2 bg-gray-50 border-none rounded-xl text-sm text-gray-900 focus:ring-1 focus:ring-black transition-all outline-none"
                       value="{{ form_values.get('motivo_val', '') }}"
                       placeholder="Ej. Consulta">
            </div>
        </div>

        <!-- Observaciones -->
        <div>
            <textarea name="observaciones" id="observaciones" rows="2"
                      class="w-full px-3 py-2 bg-gray-50 border-none rounded-xl text-sm text-gray-900 focus:ring-1 focus:ring-black transition-all outline-none resize-none placeholder-gray-400"
                      placeholder="Notas adicionales...">{{ form_values.get('observaciones_val', '') }}</textarea>
        </div>

        <!-- Botones de Acción: Grid de 2 columnas para ahorrar espacio -->
        <div class="grid grid-cols-2 gap-3 mt-4">
            
            <!-- Lógica para URL de Cancelar -->
            {% set cancel_url = form_values.get('next_url') or request.args.get('next') %}
            {% if not cancel_url %}
                {% set cancel_url = url_for('calendario.mostrar_calendario') %}
            {% endif %}

            <!-- Botón Cancelar (Gris Claro) -->
            <a href="{{ cancel_url }}" 
               class="flex items-center justify-center w-full py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-900 font-bold rounded-xl transition-all duration-200 text-sm">
                Cancelar
            </a>

            <!-- Botón Guardar (Negro) -->
            <button type="submit" class="flex items-center justify-center w-full py-3 bg-black hover:bg-gray-800 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition-all duration-200 gap-2 text-sm">
                <span>Agendar</span>
                <i data-lucide="check" class="w-4 h-4"></i>
            </button>
        </div>

        {# Alerta de duplicados (oculta por defecto) #}
        {% if form_values.get('mostrar_seccion_duplicados') %}
        <div class="mt-2 p-3 bg-amber-50 rounded-xl border border-amber-100 text-xs">
            <p class="text-amber-800 font-bold mb-1">⚠️ Duplicados</p>
            <select class="w-full p-1 rounded border-amber-200 bg-white" id="paciente_id_seleccionado_duplicado" name="paciente_id_seleccionado_duplicado">
                {% for p in form_values.posibles_pacientes_encontrados %}
                    <option value="{{ p.id }}">{{ p.nombres }} {{ p.apellidos }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </form>
</div>
{% endblock %}


{% block scripts %}
    {{ super() }}
    <!-- Scripts se mantienen IDÉNTICOS, solo asegúrate de que search_utils.js esté cargando bien -->
    <script type="module"> 
        import { initializePatientSearch, preloadPatient } from "{{ url_for('static', filename='js/search_utils.js') }}";

        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();

            const pacienteBusquedaInput = document.getElementById('paciente_busqueda_input');
            const pacienteIdHiddenInput = document.getElementById('paciente_id_seleccionado_hidden');
            const sugerenciasCitasDiv = document.getElementById('sugerencias_citas');
            const smallCrearNuevoPaciente = document.getElementById('small_crear_nuevo_paciente');

            const inputNombres = document.getElementById('paciente_nombres');
            const inputApellidos = document.getElementById('paciente_apellidos');
            const inputTelefono = document.getElementById('paciente_telefono');
            const inputEdad = document.getElementById('paciente_edad');
            const inputDocumento = document.getElementById('paciente_documento');

            const camposNuevoPaciente = [
                inputNombres, inputApellidos, inputTelefono, inputEdad, inputDocumento
            ];

            function clearNewPatientFields() {
                inputNombres.value = '';
                inputApellidos.value = '';
                inputTelefono.value = '';
                inputEdad.value = '';
                inputDocumento.value = '';
                pacienteIdHiddenInput.value = ''; 
            }

            async function populateNewPatientFields(patientData) {
                if (!patientData) { 
                    clearNewPatientFields();
                    toggleNewPatientFields(true);
                    return;
                }
                const nombreCompletoArr = patientData.nombre.split(' ');
                inputNombres.value = nombreCompletoArr.shift(); 
                inputApellidos.value = nombreCompletoArr.join(' ');
                
                inputTelefono.value = patientData.telefono !== 'No especificado' ? patientData.telefono : '';
                inputEdad.value = patientData.edad !== 'No especificada' ? patientData.edad : '';
                inputDocumento.value = patientData.documento !== 'No especificado' ? patientData.documento : '';
            }

            function toggleNewPatientFields(enable) {
                camposNuevoPaciente.forEach(campo => {
                    if (campo) {
                        campo.disabled = !enable;
                        if (enable) {
                            if (campo.id === 'paciente_nombres' || campo.id === 'paciente_apellidos' || campo.id === 'paciente_telefono') {
                                campo.setAttribute('required', 'required');
                            }
                        } else {
                            campo.removeAttribute('required');
                        }
                    }
                });
                if (smallCrearNuevoPaciente) {
                    // Mantenemos la lógica de visibilidad pero usando clases de Tailwind si quisieras, 
                    // aunque el JS usa style.display, lo cual funciona perfecto.
                    smallCrearNuevoPaciente.style.display = enable ? 'block' : 'none';
                }
            }

            if (pacienteBusquedaInput && sugerenciasCitasDiv && pacienteIdHiddenInput) {
                initializePatientSearch(pacienteBusquedaInput, sugerenciasCitasDiv, pacienteIdHiddenInput, 
                                        async (patientData) => { 
                                            await populateNewPatientFields(patientData);
                                            toggleNewPatientFields(false); 
                                        }, 
                                        () => { 
                                            clearNewPatientFields();
                                            toggleNewPatientFields(true); 
                                        });
            } else {
                console.error('ERROR DOM: Faltan elementos ID');
            }

            const initialPatientId = pacienteIdHiddenInput.value;
            if (initialPatientId) {
                preloadPatient(initialPatientId, pacienteBusquedaInput, pacienteIdHiddenInput, 
                                async (patientData) => { 
                                    await populateNewPatientFields(patientData);
                                    toggleNewPatientFields(false); 
                                })
                .catch(error => {
                    console.error('Error precarga:', error);
                    clearNewPatientFields();
                    toggleNewPatientFields(true);
                });
            } else {
                toggleNewPatientFields(true);
            }
        });
    </script>
{% endblock %}