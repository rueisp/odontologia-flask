{% extends 'base.html' %}

{% block title %}Registrar Paciente{% endblock %}

{% block head_extra %}
    {# Si tienes CSS específico para el dentigrama que no está en avatar_upload.css #}
    {# <link rel="stylesheet" href="{{ url_for('static', filename='css/dentigrama_styles.css') }}"> #}
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center">Registrar Paciente</h2>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div id="flash-message" data-message="{{ messages[0] }}"></div>
        {% endif %}
    {% endwith %}

    <form action="{{ url_for('pacientes.crear_paciente') }}" method="post" enctype="multipart/form-data" id="patientMainForm">
        
        {# Ahora _accordion_registro_paciente.html contendrá TODOS los items del acordeón,
           incluyendo la sección de Datos Personales que antes estaba en un fieldset. #}
        {% include '_accordion_registro_paciente.html' with context %} 
        
        <div class="mt-5 mb-5 d-flex gap-3 justify-content-center">
            <button type="submit" class="btn btn-dark" id="mainSaveButton">Guardar</button>
            <a href="{{ url_for('pacientes.lista_pacientes') }}" class="btn btn-secondary">Volver</a>
        </div>
    </form>
</div>

{# Modal para Ampliar Imagen de Perfil (si quieres que también funcione aquí) #}
{# Asegúrate de que este modal esté presente si el script avatar_upload.js lo usa #}
<div class="modal fade" id="avatarZoomModal" tabindex="-1" aria-labelledby="avatarZoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="avatarZoomModalLabel">Imagen de Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="zoomedAvatarImage" src="" class="img-fluid rounded" alt="Imagen de Perfil Ampliada">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
    <!-- ... tu script de flash messages ... -->

    <script src="{{ url_for('static', filename='js/editor_dentigrama.js') }}"></script>
    <script src="{{ url_for('static', filename='js/avatar_upload.js') }}"></script> 

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("MAIN PAGE SCRIPT: DOMContentLoaded fired from registrar_paciente.html."); 
            
            // --- Lógica para el cálculo de la edad (se mantiene igual) ---
            const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
            const edadInput = document.getElementById('edad');

            if (fechaNacimientoInput && edadInput) { 
                fechaNacimientoInput.addEventListener('change', function () {
                    const fechaNacimiento = new Date(this.value);
                    const hoy = new Date();

                    let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
                    const mes = hoy.getMonth() - fechaNacimiento.getMonth();

                    if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
                        edad--;
                    }
                    edadInput.value = edad;
                    console.log("EDAD SCRIPT DEBUG: Edad calculada:", edad);
                });
                if (fechaNacimientoInput.value) {
                     fechaNacimientoInput.dispatchEvent(new Event('change'));
                }
            } else {
                console.warn("EDAD SCRIPT WARNING: No se encontraron los inputs de Fecha de Nacimiento o Edad. ID's esperados: 'fecha_nacimiento', 'edad'.");
            }
            // --- FIN Lógica para el cálculo de la edad ---

            // --- Lógica del formulario principal de paciente ---
            const mainForm = document.getElementById('patientMainForm');
            const mainSaveButton = document.getElementById('mainSaveButton'); 
            const dentigramaUrlInput = document.getElementById('dentigrama_url_input');

            if (mainForm && mainSaveButton) {
                console.log("MAIN PAGE SCRIPT: patientMainForm and mainSaveButton found.");
                
                const mainSaveButtonHandler = async function(event) { 
                    event.preventDefault(); 
                    console.log("MAIN PAGE SCRIPT: Save button CLICK event detected. Starting save process.");

                    mainSaveButton.disabled = true;
                    mainSaveButton.textContent = 'Guardando Paciente...';
                    
                    try {
                        let finalDentigramUrl = dentigramaUrlInput.value; 
                        console.log("MAIN PAGE SCRIPT: Final Dentigram URL antes del envío del formulario:", finalDentigramUrl);

                        const formData = new FormData(mainForm); 
                        formData.set('dentigrama_canvas', finalDentigramUrl || ''); 

                        console.log("MAIN PAGE SCRIPT: About to submit main form via fetch with dentigrama_canvas:", formData.get('dentigrama_canvas'));
                        
                        const response = await fetch(mainForm.action, {
                            method: mainForm.method, 
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`Error HTTP: ${response.status} - ${errorData.error || 'Error desconocido del servidor.'}`);
                        }

                        const result = await response.json(); 
                        console.log("MAIN PAGE SCRIPT: Server responded:", result);

                        if (result.success) {
                            alert(result.message || "Paciente guardado exitosamente. Redirigiendo...");
                            window.location.href = result.redirect_url; 
                        } else {
                            throw new Error(result.error || "Error desconocido al guardar el paciente.");
                        }

                    } catch (error) {
                        console.error("MAIN PAGE SCRIPT ERROR: Error al guardar el paciente:", error);
                        alert("Hubo un error al guardar el paciente: " + error.message);
                    } finally {
                        mainSaveButton.disabled = false;
                        mainSaveButton.textContent = 'Guardar';
                    }
                }; 
                
                mainSaveButton.removeEventListener('click', mainSaveButtonHandler);
                mainSaveButton.addEventListener('click', mainSaveButtonHandler);
                console.log("MAIN PAGE SCRIPT: Listener para 'mainSaveButton' adjuntado/re-adjuntado.");

            } else { 
                console.error("MAIN PAGE SCRIPT ERROR: No se encontró el formulario principal con ID 'patientMainForm' o el botón 'mainSaveButton'.");
            }
            // --- FIN Lógica del formulario principal de paciente ---

            // --- Lógica para inicializar el dentigrama cuando su acordeón se abre (se mantiene igual) ---
            const dentigramaCollapseElement = document.getElementById('collapseDentigrama');
            if (dentigramaCollapseElement) {
                dentigramaCollapseElement.addEventListener('shown.bs.collapse', function () {
                    console.log("MAIN PAGE SCRIPT: Acordeón del dentigrama abierto. Reinicializando dentigrama...");
                    if (typeof window.initializeDentigram === 'function') {
                        window.initializeDentigram(); 
                    } else {
                        console.error("MAIN PAGE SCRIPT ERROR: window.initializeDentigram no está disponible globalmente.");
                    }
                });
            } else {
                console.warn("MAIN PAGE SCRIPT WARNING: No se encontró el elemento del acordeón del dentigrama con ID 'collapseDentigrama'.");
            }
            // --- FIN Lógica de inicialización del dentigrama ---

        });
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log("Iniciando script de municipios...");
                const departamentoSelect = document.getElementById('codigo_dpto');
                const municipioSelect = document.getElementById('codigo_mpio');
                
                if (!departamentoSelect || !municipioSelect) {
                    console.error('ERROR: No se encontraron los selectores de departamento o municipio.');
                    return;
                }
                
                // Imprime el JSON en la consola para depurar
                const municipiosJsonString = '{{ municipios_json | safe }}';
                console.log("JSON de municipios recibido del backend:", municipiosJsonString);
                
                const todosLosMunicipios = JSON.parse(municipiosJsonString);
                
                function cargarMunicipios(codigoDepto) {
                    console.log("Cargando municipios para el depto:", codigoDepto);
                    municipioSelect.innerHTML = '<option value="">Seleccione un municipio</option>';
                    
                    if (!codigoDepto) {
                        municipioSelect.disabled = true;
                        return;
                    }
                    
                    const municipiosFiltrados = todosLosMunicipios.filter(m => m.codigo_departamento === codigoDepto);
                    console.log("Municipios encontrados:", municipiosFiltrados.length);
                    
                    if (municipiosFiltrados.length > 0) {
                        municipioSelect.disabled = false;
                        municipiosFiltrados.forEach(muni => {
                            const option = document.createElement('option');
                            option.value = muni.codigo;
                            option.textContent = muni.nombre;
                            municipioSelect.appendChild(option);
});
                    } else {
                        municipioSelect.disabled = true;
                    }
                }
                
                departamentoSelect.addEventListener('change', function() {
                    cargarMunicipios(this.value);
                });
                
                // Carga inicial (por si se edita, aunque aquí es 'crear')
                if (departamentoSelect.value) {
                    cargarMunicipios(departamentoSelect.value);
                } else {
                    municipioSelect.disabled = true;
                }

            } catch(e) {
                console.error("ERROR FATAL en el script de carga de municipios:", e);
            }
        });
    </script>
{% endblock %}